#!/usr/bin/ruby
# Bootstrap server with fog

require 'rubygems'
require 'net/ping'
require 'fog'
require 'optiflag'

# The ENV['FOG_RC'] variable should be set to the configuration here.
f = File.open(
      File.expand_path(
        File.join(
          File.dirname(__FILE__),"../config/bootstrap_chef.sh")))

connection = Fog::Compute.new(
  :provider => "AWS",
  :aws_access_key_id => Fog::credentials[:aws_access_key_id],
  :aws_secret_access_key => Fog::credentials[:aws_secret_access_key]
  )

server = connection.servers.create(
  :image_id => Fog::credentials[:image_id],
  :key_name => Fog::credentials[:key_name],
  :user_data => f.read
)
server.wait_for { 

  if ( state == "running" )
    puts "Instance network up, booting services"
    webserver = Net::Ping::HTTP.new("http://#{dns_name}:80/")
    result = webserver.ping?
    if ( result == true )
      puts "Your tornom node is up"
      puts "http://#{dns_name}:9091/"
      break
    else
      puts "Waiting for services..."
    end
  else
    puts "Instance initializing..."
  end

}
